package com.mrbackend.admin;

import android.content.Intent;
import android.os.Bundle;
import android.widget.Button;
import android.widget.EditText;
import android.widget.Toast;

import androidx.appcompat.app.AppCompatActivity;

import java.io.OutputStream;
import java.net.HttpURLConnection;
import java.net.URL;
import java.util.Scanner;

// کلاس فعالیت تأیید کد OTP (One-Time Password)
public class VerifyOtpActivity extends AppCompatActivity {

    // تعریف فیلدهای ورودی کد OTP و دکمه تأیید
    EditText edtOtp;
    Button btnVerify;
    // متغیر برای ذخیره ایمیل دریافتی از صفحه قبل
    String email;

    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        // تنظیم لایه XML مربوط به این فعالیت
        setContentView(R.layout.activity_verify_otp);

        // اتصال متغیرها به المان‌های موجود در لایه
        edtOtp = findViewById(R.id.edtOtp);
        btnVerify = findViewById(R.id.btnVerify);

        // دریافت ایمیل از Intent صفحه قبل
        email = getIntent().getStringExtra("email");

        // تنظیم شنونده کلیک برای دکمه تأیید
        btnVerify.setOnClickListener(v -> {
            // دریافت و حذف فاصله‌های اضافی از کد وارد شده
            String otp = edtOtp.getText().toString().trim();
            // بررسی خالی نبودن کد
            if (otp.isEmpty()) {
                Toast.makeText(this, "کد را وارد کنید", Toast.LENGTH_SHORT).show();
                return;
            }
            // ارسال کد برای تأیید
            verifyOtp(otp);
        });
    }

    // تابع تأیید کد OTP با سرور
    private void verifyOtp(String otp) {
        // ایجاد یک رشته جدید برای انجام عملیات شبکه
        new Thread(() -> {
            try {
                // ایجاد آدرس URL سرور برای تأیید کد
                URL url = new URL("https://b.mrbackend.ir/api/verify_otp.php");
                HttpURLConnection conn = (HttpURLConnection) url.openConnection();
                // تنظیم متد درخواست به POST
                conn.setRequestMethod("POST");
                // اجازه ارسال داده در بدنه درخواست
                conn.setDoOutput(true);

                // ساخت داده‌های فرم برای ارسال (ایمیل و کد OTP)
                String data = "email=" + email + "&otp=" + otp;
                // دریافت جریان خروجی برای نوشتن داده‌ها
                OutputStream os = conn.getOutputStream();
                // نوشتن داده‌ها به جریان خروجی
                os.write(data.getBytes());
                // اطمینان از ارسال کامل داده‌ها
                os.flush();
                // بستن جریان خروجی
                os.close();

                // دریافت کد وضعیت پاسخ از سرور
                int responseCode = conn.getResponseCode();
                // ایجاد اسکنر برای خواندن پاسخ سرور
                Scanner sc = new Scanner(conn.getInputStream());
                // ساخت StringBuilder برای جمع‌آوری پاسخ
                StringBuilder sb = new StringBuilder();
                // خواندن تمام خطوط پاسخ
                while (sc.hasNext()) sb.append(sc.nextLine());
                // بستن اسکنر
                sc.close();

                // تبدیل پاسخ به رشته
                String response = sb.toString();

                // بازگشت به رشته اصلی UI برای به‌روزرسانی رابط کاربری
                runOnUiThread(() -> {
                    // بررسی پاسخ سرور برای موفقیت‌آمیز بودن
                    if (response.contains("\"status\":\"success\"")) {
                        Toast.makeText(this, "احراز هویت موفق", Toast.LENGTH_SHORT).show();
                        // رفتن به صفحه اصلی (HomeActivity) در صورت موفقیت
                        startActivity(new Intent(this, HomeActivity.class));
                        // بستن این فعالیت
                        finish();
                    } else {
                        // نمایش پیام خطا در صورت اشتباه بودن کد
                        Toast.makeText(this, "کد اشتباه است", Toast.LENGTH_SHORT).show();
                    }
                });

            } catch (Exception e) {
                // چاپ خطا در کنسول برای دیباگ
                e.printStackTrace();
                // نمایش خطا به کاربر در صورت بروز مشکل
                runOnUiThread(() -> Toast.makeText(this, "خطا: " + e.getMessage(), Toast.LENGTH_SHORT).show());
            }
        }).start();  // شروع رشته جدید
    }
}